# ============================================================================
# Planning Gate Dispatcher â€” Org-level workflow
#
# Polls the org project board every 5 minutes. When a Feature issue is in
# "Planning" status and hasn't been processed yet, dispatches the
# planning-gate workflow in the Platform repo.
#
# WHY POLLING: The projects_v2_item webhook event is NOT a supported
# GitHub Actions trigger (it's webhook-only, not listed in the Actions
# "Events that trigger workflows" docs). Schedule polling is the reliable
# alternative.
#
# DEDUP: Uses a 'planning-gate-dispatched' label on the issue to prevent
# re-dispatching on subsequent polls.
#
# MANUAL: Can also be triggered via workflow_dispatch for testing.
# ============================================================================

name: Planning Gate Dispatcher

on:
  schedule:
    # Every 5 minutes
    - cron: '*/5 * * * *'
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Specific issue number to dispatch (skips project board scan)"
        required: false
        type: string

permissions:
  contents: read

jobs:
  dispatch:
    name: Dispatch Planning Gate
    runs-on: ubuntu-latest

    steps:
      - name: Dispatch for specific issue (manual trigger)
        if: inputs.issue_number != ''
        env:
          GH_TOKEN: ${{ secrets.PLANNING_GATE_TOKEN_ORG }}
        run: |
          ISSUE_NUM="${{ inputs.issue_number }}"
          echo "Manual dispatch for issue #$ISSUE_NUM"

          gh workflow run planning-gate.yml \
            --repo "UniqLearn/Platform" \
            --field issue_number="$ISSUE_NUM"
          echo "Dispatched planning-gate for issue #$ISSUE_NUM"

      - name: Scan project board for Planning items
        if: inputs.issue_number == ''
        env:
          GH_TOKEN: ${{ secrets.PLANNING_GATE_TOKEN_ORG }}
        run: |
          echo "Scanning project board for Feature issues in Planning status..."

          # Query project #11 for items with Status = Planning
          ITEMS=$(gh api graphql -f query='
            query {
              organization(login: "UniqLearn") {
                projectV2(number: 11) {
                  items(first: 50) {
                    nodes {
                      fieldValueByName(name: "Status") {
                        ... on ProjectV2ItemFieldSingleSelectValue { name }
                      }
                      content {
                        ... on Issue {
                          number
                          repository { name owner { login } }
                          issueType { name }
                          labels(first: 20) {
                            nodes { name }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }')

          echo "Query complete. Filtering for Planning + Feature + Platform..."

          # Parse and filter items
          echo "$ITEMS" | jq -r '
            .data.organization.projectV2.items.nodes[]
            | select(
                .fieldValueByName.name == "Planning"
                and .content.issueType.name == "Feature"
                and .content.repository.name == "Platform"
                and .content.repository.owner.login == "UniqLearn"
                and ([.content.labels.nodes[].name] | index("planning-gate-dispatched") | not)
              )
            | .content.number
          ' | while read -r ISSUE_NUM; do
            if [ -z "$ISSUE_NUM" ]; then
              continue
            fi

            echo "Found unprocessed Planning item: issue #$ISSUE_NUM"

            # Dispatch planning-gate workflow
            echo "Dispatching planning-gate for #$ISSUE_NUM..."
            gh workflow run planning-gate.yml \
              --repo "UniqLearn/Platform" \
              --field issue_number="$ISSUE_NUM"

            # Add dedup label so we don't re-dispatch next poll
            echo "Adding planning-gate-dispatched label to #$ISSUE_NUM..."
            gh api repos/UniqLearn/Platform/labels \
              --method POST \
              --field name="planning-gate-dispatched" \
              --field color="c5def5" \
              --field description="Planning gate has been dispatched for this issue" \
              2>/dev/null || true

            gh issue edit "$ISSUE_NUM" \
              --repo "UniqLearn/Platform" \
              --add-label "planning-gate-dispatched"

            echo "Done with #$ISSUE_NUM"
          done

          echo "Scan complete."
